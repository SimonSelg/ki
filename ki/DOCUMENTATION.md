# Version control

When you 

```
$ ki clone ~/.local/share/Anki2/ decks
Creating directory ~/.local/share/ki/
Found `collection.anki2` file at ~/.local/share/Anki2/User\ 1/collection.anki2
Cloning into ~/.local/share/ki/User\ 1/remote/
Running `git init`
Running `git add .`
Running `git commit -m "ki clone"`
Creating directory ./decks/
Running `git clone ~/.local/share/ki/User\ 1/remote/.git decks`
Moving directory `~/.local/share/ki/User\ 1/remote/` to `~/.local/share/ki/_private/User\ 1/remote/`
```

Start anki
Sync
Close anki
Start ki
Ki converts the .anki2 file into a git repo.
Ki puts the git repo where the user can see it.
The user edits the git repo.
Maybe the user pushes changes to ankiweb from another computer.
The user also edits some cards in the local installation of Anki.
We must merge three different branches.
It is safe to assume the remote ankiweb changes are not notetype changes.
So we can sync safely and we have our local and ankiweb branches in sync.
Now we need only merge two branches.
It does not make sense to overwrite the .anki2 file, because that is dangerous.
So we pull the updated .anki2 file into another git repo.
And we merge the two in git.
Then we overwrite the .anki2 file.
But how do we know it's safe to overwrite?

```
$ ki push
Error: last `ki pull` was before latest commit
(can't see remote because it's in `ki/_private/`)
$ ki pull

```


# Generating html
-----------------
By default, `ki` parses the html of each field and dumps the content-only,
insofar as that is possible. It also supports parsing arbitrary html elements
autogenerated by addons and regenerated the updated content. In the following
subsection, we walk through an example.

## Generating syntax-highlighted code blocks
--------------------------------------------
The anki addon developer Glutanimate has an addon called `syntax-highlighting`,
which adds UI elements to the Anki note editor that automatically generates a
syntax highlighted version of a code block from the clipboard. In effect, it
generates a formatted HTML table for the code listing that gets dumped into the
source of relevant note field.

A fork of this addon for the latest version of Anki (2.1.49 at the time of
writing), is available here:
https://ankiweb.net/shared/info/1972239816

And the source tree for the original addon is on github:
https://github.com/glutanimate/syntax-highlighting


For example, consider the following python code block:
```python
n = 1
n >> 1
print(n)
```

Given the above code, the addon generates the following HTML:
```html
<table class="highlighttable">
    <tbody>
        <tr>
            <td class="linenos">
                <div class="linenodiv">
                    <pre>
                        <span class="normal">1</span>
                        <span class="normal">2</span>
                        <span class="normal">3</span>
                    </pre>
                </div>
            </td>
            <td class="code">
                <div class="highlight">
                    <pre>
                        <code>
                            <span class="n">n</span>
                            <span class="o">=</span>
                            <span class="mi">1</span>
                            <br>
                                <span class="n">n</span>
                                <span class="o">&gt;&gt;</span>
                                <span class="mi">1</span>
                                <br>
                                    <span class="nb">print</span>
                                    <span class="p">(</span>
                                    <span class="n">n</span>
                                    <span class="p">)</span>
                                    <br>
                                    </code>
                                </pre>
                </div>
            </td>
        </tr>
    </tbody>
</table>
```
Editing fields like this could become annoying very quickly. It would be better
if `ki` just gave us the markdown version above (only 3 lines), and then
regenerated the note field HTML when converting the repository back into a
`.anki2` deck.

### Adding `ki` HTML attributes

And in fact, this is possible. We first fork the addon so we can add some extra
data to our generated HTML. In particular, we'd like to add an attribute
`ki-src` whose value is the UTF-8 encoded source code. In general, this will be
the encoded version of the source of whatever you'd like to autoformat.

We also add a `ki-formatter` attribute, whose value is an identifier that
specifies a custom python module (we must implement this) that transforms the
(possibly edited) `ki-src` text back into a HTML element of the form seen
above.

So let's call our `ki-formatter` identifier `syntax-hl-python`. Then our addon
has to change the opening tag of the snippet above to look like:
```html
<table class="highlighttable"; ki-src="n = 1\nn >> 1\nprint(n)\n"; ki-formatter="syntax-hl-python">
```

All `ki` needs is the original text of the code block prior to html formatting,
and a function that can reapply the formatting to the modified text. Since the
html table was generated by an addon, we already have a python function for
this, and in general you can provide a `~/.config/ki/ki.json` file that maps
implementation IDs to paths of python modules. The module must have a top-level
function defined of the form `format(text: str) -> bs4.Tag`. If you have an
addon implementation, you can import it here and use it in your `format()`
implementation. you can add a `ki` attribute whose value is the base64 encoding
of the code block, and a `implementation` attribute whose value is the name of
a function. At import-time, `ki` will decode this and 

Requirements
------------
```bash
pip install -r requirements.txt
```


Gotchas
-------

- c
