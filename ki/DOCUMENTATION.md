# Model

```
                 +-------------+          +--------------+
                 |             |          |              |
                 |   AnkiWeb  -------------  AnkiMobile  |
                 |             |   sync   |              |
                 +------|------+          +--------------+
                        |
                        | sync
                        |
                 +------|------+
                 |             |
                 |    Anki     |
                 |   (local)   |
                 |             |
                 +------|------+
                        |
                        | deck edits
                        |
               +--------|--------+               +------------------+
               |                 |    ki clone   |                  |
               |                 ---------------->                  |
               | Collection file |               |     ~/decks/     |
               |    (.anki2)     |    ki push    | (git repository) |
               |                 <----------------                  |
               |                 |               |                  |
               +--------|--------+               +---------^--------+
                        |                                  |
                        | ki pull                          |
                        |                                  |
                        |                                  |
             +----------v----------+                       |
             |                     |                       |
             | /tmp/ki/remote/AAA  |           ki pull     |
             |  (git repository)   -------------------------
             |    [ephemeral]      |
             |                     |
             +---------------------+
```
# Version control

## Creating a new `ki` repository and setting up `ki`.
```
$ ki clone ~/.local/share/Anki2/ decks
Creating directory ~/.local/share/ki/
Found `collection.anki2` file at ~/.local/share/Anki2/User\ 1/collection.anki2
Computed md5sum ~/.local/share/Anki2/User\ 1/collection.anki2: ad7ea6d486a327042cf0b09b54626b66
Checking that there is not an existing git repo at ./decks/
Cloning into ./decks/
```

## Pulling changes from an Anki collection into an extant `ki` repository
```
$ ki pull
Removing /tmp/ki/remote/
Found `collection.anki2` file at ~/.local/share/Anki2/User\ 1/collection.anki2
Computed md5sum ~/.local/share/Anki2/User\ 1/collection.anki2: ad7ea6d486a327042cf0b09b54626b66
Updating md5sum in .ki/hashes
Cloning into ephemeral repository at /tmp/ki/remote/
Running `git remote add origin /tmp/ki/remote/ad7ea6d486a327042cf0b09b54626b66.git`
Running `git pull`
```

At this point, if the pull fails, the user can take over and manage the merge themselves.

## Pushing committed changes in a `ki` repository to an Anki collection
```
$ ki push
Checking latest hash in `.ki/hashes` matches md5sum of `~/.local/share/Anki2/User\ 1/collection.anki2`
Checking out latest commit in a temp directory
Compiling to .anki2 file
Backing up `~/.local/share/Anki2/User\ 1/collection.anki2` to `~/.local/share/Anki2/User\ 1/ki/backups/`
Overwriting `~/.local/share/Anki2/User\ 1/collection.anki2`
```
We store 5 backups of the collection prior to a push.

It is not necessary to have a persistent "remote" copy of the repo to pull
from. The remote can be ephemeral. It only exists when we `ki pull`, and then
`ki` deletes it. This is safe because we're checking the `md5sum` of
`collection.anki2`. Notably, it is not created when we `ki clone` or `ki push`.

# Generating html
-----------------
By default, `ki` parses the html of each field and dumps the content-only,
insofar as that is possible. It also supports parsing arbitrary html elements
autogenerated by addons and regenerated the updated content. In the following
subsection, we walk through an example.

## Generating syntax-highlighted code blocks
--------------------------------------------
The anki addon developer Glutanimate has an addon called `syntax-highlighting`,
which adds UI elements to the Anki note editor that automatically generates a
syntax highlighted version of a code block from the clipboard. In effect, it
generates a formatted HTML table for the code listing that gets dumped into the
source of relevant note field.

A fork of this addon for the latest version of Anki (2.1.49 at the time of
writing), is available here:
https://ankiweb.net/shared/info/1972239816

And the source tree for the original addon is on github:
https://github.com/glutanimate/syntax-highlighting


For example, consider the following python code block:
```python
n = 1
n >> 1
print(n)
```

Given the above code, the addon generates the following HTML:
```html
<table class="highlighttable">
    <tbody>
        <tr>
            <td class="linenos">
                <div class="linenodiv">
                    <pre>
                        <span class="normal">1</span>
                        <span class="normal">2</span>
                        <span class="normal">3</span>
                    </pre>
                </div>
            </td>
            <td class="code">
                <div class="highlight">
                    <pre>
                        <code>
                            <span class="n">n</span>
                            <span class="o">=</span>
                            <span class="mi">1</span>
                            <br>
                                <span class="n">n</span>
                                <span class="o">&gt;&gt;</span>
                                <span class="mi">1</span>
                                <br>
                                    <span class="nb">print</span>
                                    <span class="p">(</span>
                                    <span class="n">n</span>
                                    <span class="p">)</span>
                                    <br>
                                    </code>
                                </pre>
                </div>
            </td>
        </tr>
    </tbody>
</table>
```
Editing fields like this could become annoying very quickly. It would be better
if `ki` just gave us the markdown version above (only 3 lines), and then
regenerated the note field HTML when converting the repository back into a
`.anki2` deck.

### Adding `ki` HTML attributes

And in fact, this is possible. We first fork the addon so we can add some extra
data to our generated HTML. In particular, we'd like to add an attribute
`ki-src` whose value is the UTF-8 encoded source code. In general, this will be
the encoded version of the source of whatever you'd like to autoformat.

We also add a `ki-formatter` attribute, whose value is an identifier that
specifies a custom python module (we must implement this) that transforms the
(possibly edited) `ki-src` text back into a HTML element of the form seen
above.

So let's call our `ki-formatter` identifier `syntax-hl-python`. Then our addon
has to change the opening tag of the snippet above to look like:
```html
<table class="highlighttable"; ki-src="n = 1\nn >> 1\nprint(n)\n"; ki-formatter="syntax-hl-python">
```

All `ki` needs is the original text of the code block prior to html formatting,
and a function that can reapply the formatting to the modified text. Since the
html table was generated by an addon, we already have a python function for
this, and in general you can provide a `~/.config/ki/ki.json` file that maps
implementation IDs to paths of python modules. The module must have a top-level
function defined of the form `format(text: str) -> bs4.Tag`. If you have an
addon implementation, you can import it here and use it in your `format()`
implementation. you can add a `ki` attribute whose value is the base64 encoding
of the code block, and a `implementation` attribute whose value is the name of
a function. At import-time, `ki` will decode this and write the human-readable
source to the relevant markdown file instead.
